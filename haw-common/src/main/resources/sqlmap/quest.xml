<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="questMapper">
	<select id="questSelectAll">
	<![CDATA[
		SELECT A.quest_no
		     , E.nation_nm || ' > ' || D.city_nm || ' > ' || C.region_nm
		     , A.quest_seq
		     , B2.gubun_nm AS type
		     , B1.gubun_nm AS level
		     , (
		        SELECT string_agg(inA.tag_nm, ',') AS tag_nm
		          FROM haw.tag inA
		         WHERE inA.tag_no IN (SELECT CAST(UNNEST(string_to_array(SUBSTR(inB.tag_str, 2, LENGTH(inB.tag_str)-2), '|')) AS Integer)
		                                FROM haw.quest inB
		                               WHERE inB.quest_no = A.quest_no)     
		       ) AS tag_nm
			 , A.open_yn
		     , A.badge_cnt
		     , A.quest_clear
		     , A.quest_nm
		     , A.auth
		     , A.description
		     , A.point
		     , A.input_dt
		  FROM haw.quest A
		       LEFT OUTER JOIN haw.gubun B1 ON (A.level = CAST(B1.gubun_cd AS Integer) AND B1.column_nm = 'level')
		       LEFT OUTER JOIN haw.gubun B2 ON (a.type = B2.gubun_cd AND B2.column_nm = 'type').
		       LEFT OUTER JOIN haw.region C ON (A.region_no = C.region_no)
		       LEFT OUTER JOIN haw.city D ON (C.city_serial = D.city_serial)
		       LEFT OUTER JOIN haw.nation E ON (D.nation_serial = E.nation_serial)
		 WHERE A.region_no = 2
		 ORDER BY A.quest_seq ASC	
	]]>
	</select>

</mapper>