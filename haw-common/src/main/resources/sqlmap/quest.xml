<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="questMapper">
	<select id="questSelectAll">
	<!-- 퀘스트 전체 리스트 -->
	<![CDATA[
		SELECT A.quest_no
		     , E.nation_nm || ' > ' || D.city_nm || ' > ' || C.region_nm
		     , A.quest_seq
		     , B2.gubun_nm AS type
		     , B1.gubun_nm AS level
		     , (
		        SELECT string_agg(inA.tag_nm, ',') AS tag_nm
		          FROM haw.tag inA
		         WHERE inA.tag_no IN (SELECT CAST(UNNEST(string_to_array(SUBSTR(inB.tag_str, 2, LENGTH(inB.tag_str)-2), '|')) AS Integer)
		                                FROM haw.quest inB
		                               WHERE inB.quest_no = A.quest_no)     
		       ) AS tag_nm
			 , A.open_yn
		     , A.badge_cnt
		     , A.quest_clear
		     , A.quest_nm
		     , A.auth
		     , A.description
		     , A.point
		     , A.input_dt
		  FROM haw.quest A
		       LEFT OUTER JOIN haw.gubun B1 ON (A.level = CAST(B1.gubun_cd AS Integer) AND B1.column_nm = 'level')
		       LEFT OUTER JOIN haw.gubun B2 ON (a.type = B2.gubun_cd AND B2.column_nm = 'type')
		       LEFT OUTER JOIN haw.region C ON (A.region_no = C.region_no)
		       LEFT OUTER JOIN haw.city D ON (C.city_serial = D.city_serial)
		       LEFT OUTER JOIN haw.nation E ON (D.nation_serial = E.nation_serial)
		 WHERE A.region_no = 2
		   AND A.archive_yn = false
		 ORDER BY A.quest_seq ASC	
	]]>
	</select>
	
	<select id="questSelect">
	<!-- 한건의 퀘스트에 대한 상세보기 -->
	<![CDATA[
		SELECT A.quest_no
		     , E.nation_nm || ' > ' || D.city_nm || ' > ' || C.region_nm
		     , A.quest_seq
		     , B2.gubun_nm AS type
		     , B1.gubun_nm AS level
		     , (
		        SELECT string_agg(inA.tag_nm, ',') AS tag_nm
		          FROM haw.tag inA
		         WHERE inA.tag_no IN (SELECT CAST(UNNEST(string_to_array(SUBSTR(inB.tag_str, 2, LENGTH(inB.tag_str)-2), '|')) AS Integer)
		                                FROM haw.quest inB
		                               WHERE inB.quest_no = A.quest_no)     
		       ) AS tag_nm
			 , A.open_yn
		     , A.badge_cnt
		     , A.quest_clear
		     , A.quest_nm
		     , A.auth
		     , A.description
		     , A.point
		     , A.input_dt
		  FROM haw.quest A
		       LEFT OUTER JOIN haw.gubun B1 ON (A.level = CAST(B1.gubun_cd AS Integer) AND B1.column_nm = 'level')
		       LEFT OUTER JOIN haw.gubun B2 ON (a.type = B2.gubun_cd AND B2.column_nm = 'type')
		       LEFT OUTER JOIN haw.region C ON (A.region_no = C.region_no)
		       LEFT OUTER JOIN haw.city D ON (C.city_serial = D.city_serial)
		       LEFT OUTER JOIN haw.nation E ON (D.nation_serial = E.nation_serial)
		 WHERE A.quest_no = 1
		   AND A.archive_yn = false
		 ORDER BY A.quest_seq ASC	
	]]>
	</select>
	
	<insert id="questInsert">
	<!-- 퀘스트 등록 -->
	<![CDATA[
		INSERT INTO haw.quest (
		       region_no
		     , quest_seq
		     , type
		     , tag_str
		     , open_yn
		     , badge_cnt
		     , quest_clear
		     , quest_nm
		     , auth
		     , level
		     , description
		     , point
		) VALUES (
		       2
		     , (SELECT MAX(COALESCE(quest_seq, 0)) + 1 FROM haw.quest WHERE region_no = 2)
		     , 'B'
		     , '|2|'
		     , true
		     , 0
		     , 1
		     , 'QUEST3'
		     , 'HEP{123456}'
		     , 10
		     , 'Compute Science'
		     , 500
		)	
	]]>
	</insert>
	
	<update id="questDelete">
	<!-- 퀘스트 삭제 -->
	<![CDATA[
		UPDATE TABLE haw.quest SET
		       archive_yn = true
		 WHERE quest_no = 1
	]]>
	</update>

	<!-- << 지역변경시에 번호 변경>>> -->
	<select id="questRegionSelect">
	<!-- 기존의 지역번호와 순서를 가져옴 -->
	<![CDATA[
		SELECT A.region_no
		     , A.quest_seq
		  FROM haw.quest A
		 WHERE A.quest_no = 2
	]]>
	</select>
	
	<update id="questSeqUpdateAll">
	<!-- 해당 퀘스트 밑의 순서의 해당하는 퀘스트의 순서번호를 변경함 -->
	<![CDATA[
		UPDATE TABLE haw.quest SET
		       quest_seq = quest_seq -1
		 WHERE region_no = 2
		   AND quest_seq > 2	
	]]>
	</update>
	
	<update id="questSeqUpdate">
	<!-- 해당 퀘스트의 순서번호를 새지역의 가장 나중으로 설정함 -->
	<![CDATA[
		UPDATE TABLE haw.quest SET
		       region_no = 3 -- 3번이라는 새로운 지역
		     , quest_seq = (SELECT COALESCE(MAX(quest_seq), 0) + 1 FROM haw.quest WHERE region_no = 3)
		 WHERE quest_no = 2		
	]]>
	</update>
	
	<select id="questDirectedExistsSelect">
	<!-- 관련퀘스트 중복여부 체크  -->
	<![CDATA[
		SELECT COUNT(*)
		  FROM haw.quest_directed A
		 WHERE A.quest_no = 3
		   AND A.direct_no = 2
	]]>
	</select>
	
	<insert id="questDirectedInsert">
	<!-- 관련퀘스트 입력  -->
	<![CDATA[
		INSERT INTO haw.quest_directed (
		       quest_no
		     , direct_no
		     , required_yn
		) VALUES (
			   3
			 , 2
			 , false
		)
	]]>
	</insert>
	
	<delete id="questDirectedDelete">
	<!-- 관련퀘스트 삭제  -->
	<![CDATA[
		DELETE FROM haw.quest_directed
		 WHERE quest_no = 3
		   AND direct_no = 2
	]]>
	</delete>
	
	<select id="questBadgeExistsSelect">
	<!-- 퀘스트 오픈조건 - 뱃지중복체크  -->
	<![CDATA[
		SELECT COUNT(*)
		  FROM haw.quest_badge A
		 WHERE A.quest_no = 3
		   AND A.badge_no = 2
	]]>
	</select>
	
	<insert id="questBadgeInsert">
	<!-- 퀘스트오픈조건 - 뱃지등록  -->
	<![CDATA[
		INSERT INTO haw.quest_badge (
		       quest_no
		     , badge_no
		     , required_yn
		) VALUES (
			   3
			 , 2
			 , false
		)
	]]>
	</insert>
	
	<delete id="questBadgeDelete">
	<!-- 퀘스트오픈조건 - 뱃지삭제 -->
	<![CDATA[
		DELETE FROM haw.quest_badge
		 WHERE quest_no = 3
		   AND badge_no = 2
	]]>
	</delete>	
	
</mapper>